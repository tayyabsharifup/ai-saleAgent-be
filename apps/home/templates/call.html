<!DOCTYPE html>
<html>
<head>
    <title>Twilio Voice Client</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f4; }
        #phone { width: 300px; margin: 50px auto; padding: 20px; background-color: #fff; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        #status { font-size: 18px; font-weight: bold; margin-bottom: 10px; text-align: center; }
        #number-display { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; text-align: center; font-size: 20px; }
        .buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .buttons button { padding: 15px; font-size: 18px; border: none; border-radius: 5px; cursor: pointer; }
        #action-buttons { display: flex; justify-content: space-around; }
        #action-buttons button { padding: 10px 20px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; }
        #answer-button { background-color: #4CAF50; color: white; }
        #hangup-button { background-color: #f44336; color: white; }
        #log { margin-top: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; height: 100px; overflow-y: scroll; }
    </style>
</head>
<body>
    <div id="phone">
        <div id="status">Offline</div>
        <input type="text" id="number-display" placeholder="Enter a number to call">
        <div class="buttons">
            <button>1</button>
            <button>2</button>
            <button>3</button>
            <button>4</button>
            <button>5</button>
            <button>6</button>
            <button>7</button>
            <button>8</button>
            <button>9</button>
            <button>+</button>
            <button>0</button>
            <button>#</button>
        </div>
        <div id="action-buttons">
            <button id="call-button">Call</button>
            <button id="answer-button" style="display: none;">Answer</button>
            <button id="hangup-button" style="display: none;">Hang Up</button>
        </div>
        <div id="log"></div>
    </div>

    <script type="text/javascript" src="https://sdk.twilio.com/js/voice/v2.9/twilio.min.js"></script>
    <script type="text/javascript">
        const statusDiv = document.getElementById('status');
        const numberDisplay = document.getElementById('number-display');
        const callButton = document.getElementById('call-button');
        const answerButton = document.getElementById('answer-button');
        const hangupButton = document.getElementById('hangup-button');
        const logDiv = document.getElementById('log');
        const buttons = document.querySelectorAll('.buttons button');

        let device;
        let activeCall;

        function log(message) {
            logDiv.innerHTML += `<p>${message}</p>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message) {
            statusDiv.innerText = message;
        }

        async function initializeDevice() {
            log('Requesting Access Token...');
            try {
                const response = await fetch('/token/');
                const data = await response.json();
                log('Got token');
                device = new Twilio.Device(data.token);

                device.on('ready', () => {
                    log('Twilio.Device Ready');
                    updateStatus('Ready');
                });

                device.on('error', (error) => {
                    log(`Twilio.Device Error: ${error.message}`);
                    updateStatus('Error');
                });

                device.on('incoming', (call) => {
                    log(`Incoming call from ${call.parameters.From}`);
                    activeCall = call;
                    updateStatus('Incoming Call');
                    callButton.style.display = 'none';
                    answerButton.style.display = 'inline-block';
                    hangupButton.style.display = 'inline-block';

                    call.on('cancel', () => {
                        log('Call canceled');
                        resetUI();
                    });

                    call.on('disconnect', () => {
                        log('Call disconnected');
                        resetUI();
                    });

                    call.on('reject', () => {
                        log('Call rejected');
                        resetUI();
                    });
                });

            } catch (err) {
                log('Could not get a token from server');
                updateStatus('Error');
            }
        }

        function resetUI() {
            updateStatus('Ready');
            callButton.style.display = 'inline-block';
            answerButton.style.display = 'none';
            hangupButton.style.display = 'none';
            activeCall = null;
        }

        callButton.addEventListener('click', async () => {
            const params = {
                To: numberDisplay.value
            };

            if (device) {
                log(`Calling ${params.To}...`);
                const call = await device.connect({ params });
                activeCall = call;
                updateStatus('Calling');
                callButton.style.display = 'none';
                hangupButton.style.display = 'inline-block';

                call.on('disconnect', () => {
                    log('Call disconnected');
                    resetUI();
                });
            } else {
                log('Device not initialized');
            }
        });

        answerButton.addEventListener('click', () => {
            if (activeCall) {
                log('Accepting call');
                activeCall.accept();
                updateStatus('On Call');
                answerButton.style.display = 'none';
                hangupButton.style.display = 'inline-block';
            }
        });

        hangupButton.addEventListener('click', () => {
            if (activeCall) {
                log('Hanging up');
                activeCall.disconnect();
                resetUI();
            }
        });

        buttons.forEach(button => {
            button.addEventListener('click', () => {
                const digit = button.innerText;
                if (digit.length === 1) {
                    numberDisplay.value += digit;
                }
            });
        });

        initializeDevice();
    </script>
</body>
</html>